---
title: "Use Case of Almond Yield"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include = FALSE}
library(tidyverse)
library(purrr)
library(ggpubr)
source("src/almond-yield.R", local = knitr::knit_global())
```

## Conceptual Modeling

![](almond_yield.jpg)

## Application

Let's start by loading and tidying the data:

```{r}
# define column names
col_names <- c("day", "month", "year", "wy", "tmax_c", "tmin_c", "precip")

# load data frame with column names
clim <- read.table("src/clim.txt", header = TRUE, col.names = col_names)

# start data wrangling
clim_dat <- clim %>%
  # convert to numeric type 
  mutate(tmin_c = as.numeric(tmin_c),
         precip = as.numeric(precip)) %>% 
  # filter to relevant months of observation
  filter(month == c(1, 2)) 

# create temperature data frame 
temp_dat <- clim_dat %>%
  # filter to relevant month 
  filter(month == 2) %>%
  # group daily observations by year
  group_by(year) %>%
  # summarize for mean and minimum values  
  summarize(mean_tmin_feb = mean(tmin_c), 
            min_tmin_feb = min(tmin_c))

# create precipitation data frame 
precip_dat <- clim_dat %>% 
  # filter to relevant month 
  filter(month == 1) %>% 
  # group daily observations by year
  group_by(year) %>%
  # summarize for sum value
  summarize(sum_precip_jan = sum(precip))

# create final data frame 
dat <- left_join(temp_dat, precip_dat, by = "year")
```

And let's apply the function:

```{r}
almond_yield(temp_feb = dat$mean_tmin_feb, precip_jan = dat$sum_precip_jan)
```

```{r}
almond_yield(temp_feb = dat$min_tmin_feb, precip_jan = dat$sum_precip_jan)
```

## Sensitivity Analysis

```{r}
# create 20 samples of temperature in February
temp_feb <- rnorm(mean = mean(dat$mean_tmin_feb), sd = 0.1, n = 20)

# use map() to apply function to the 20 samples 
almond_yield_temp <- temp_feb %>% map(
  ~almond_yield(precip_jan = dat$sum_precip_jan, temp_feb = .x))
```

```{r}
sensitivty_dat <- as.data.frame(do.call(rbind, 
                                        lapply(almond_yield_temp, as.vector)))

sensitivty_dat <- sensitivty_dat %>% mutate(year = dat$year)
```
